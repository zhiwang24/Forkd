rules_version = '2';

service cloud.firestore {
    match /databases/{database}/documents {
        function isSignedIn() {
            return request.auth != null;
        }

        function isGatechVerified() {
            return isSignedIn()
                && request.auth.token.email_verified == true
                && request.auth.token.email.matches('(?i)^.*@gatech\\.edu$');
        }

        function isHallAdmin() {
            return isSignedIn() && (request.auth.token.admin == true
                || request.auth.token.email in ["ayane@gatech.edu", "zhi@gatech.edu"]);
        }

        // menu reports
        match /menu_reports/{docId} {
            allow read: if true;
            allow create: if isGatechVerified();
        }
 
        // recommendation banner
        match /recommendations/global {
            allow read: if true;
        }
 
        // bug reports
        match /bug_reports/{docId} {
            allow read: if isSignedIn();
            allow create: if isGatechVerified();
        }
 
        // users profile docs (one per uid)
        match /users/{uid} {
            allow read, create, update: if isSignedIn() && request.auth.uid == uid;
        }
 
        // dining halls: public read, verified GT or admins can write (needed for Moe's seeding)
        match /halls/{hallId} {
            allow read: if true;
            allow create, update, delete: if isGatechVerified() || isHallAdmin();

            match /menuItems/{itemId} {
                allow read: if true;
                allow create, update, delete: if isGatechVerified() || isHallAdmin();
            }
        }
    }
 }
